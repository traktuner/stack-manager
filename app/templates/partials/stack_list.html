{% set ns = namespace(shown_divider=false, has_active=false) %}
{% for stack in stacks %}
    {% if stack.status.state in ("running", "partial") %}
        {% set ns.has_active = true %}
    {% endif %}
{% endfor %}

{% for stack in stacks %}
{% if stack.status.state == "stopped" and not ns.shown_divider and ns.has_active %}
    {% set ns.shown_divider = true %}
    <div class="stopped-divider"><small>Stopped</small></div>
{% endif %}
<article id="stack-{{ stack.name }}" class="stack-card stack-{{ stack.status.state }}">
    <div class="stack-header">
        <div class="stack-info">
            <strong>{{ stack.name }}</strong>
            <small>
                {% if stack.mode == "pass" %}
                    <kbd class="mode-pass">pass</kbd>
                {% endif %}
                {% if stack.status.state == "running" %}
                    <span class="badge-running">{{ stack.status.running }}/{{ stack.status.total }}</span>
                {% elif stack.status.state == "partial" %}
                    <span class="badge-partial">{{ stack.status.running }}/{{ stack.status.total }}</span>
                {% else %}
                    <span class="badge-stopped">stopped</span>
                {% endif %}
            </small>
        </div>
        <div class="stack-actions">
            {% if stack.is_self %}
                <button disabled title="Cannot control stack-manager from within itself">self</button>
            {% elif stack.busy %}
                <button aria-busy="true" disabled>busy</button>
            {% elif stack.status.state in ("running", "partial") %}
                <button class="outline contrast"
                        hx-post="/api/stacks/{{ stack.name }}/stop"
                        hx-target="#modal-content"
                        hx-swap="innerHTML">Stop</button>
            {% else %}
                <button class="outline"
                        hx-post="/api/stacks/{{ stack.name }}/start"
                        hx-target="#modal-content"
                        hx-swap="innerHTML">Start</button>
            {% endif %}
        </div>
    </div>
    {% if stack.status.containers and stack.status.state != "stopped" %}
    <details class="stack-details">
        <summary class="stack-details-toggle">{{ stack.status.containers|length }} containers</summary>
        <div class="stack-containers">
            {% for c in stack.status.containers %}
            <span class="container-pill container-{{ c.status }}" data-tooltip="{{ c.image }}">
                <span class="container-name">{{ c.name }}</span>
                {% if c.health != "n/a" %}<span class="health-{{ c.health }}">{{ c.health }}</span>{% endif %}
                <button class="container-logs-btn"
                        title="View logs for {{ c.name }}"
                        onclick='showLogs({{ c.name|tojson }})'>
                    <svg viewBox="0 0 16 16" fill="currentColor" width="12" height="12">
                        <path d="M2 2h12v12H2V2zm1.5 2v8h9V4h-9zM5 6h6v1H5V6zm0 2.5h4v1H5v-1z"/>
                    </svg>
                </button>
                {% if c.status == "running" and not stack.is_self and stack.service_map.get(c.name) %}
                <button class="container-update-btn"
                        title="Pull &amp; recreate {{ c.name }}"
                        hx-post="/api/stacks/{{ stack.name }}/services/{{ stack.service_map[c.name] }}/upgrade"
                        hx-target="#modal-content"
                        hx-swap="innerHTML"
                        hx-confirm="Pull latest image and recreate {{ c.name }}?">
                    <svg viewBox="0 0 16 16" fill="currentColor" width="12" height="12">
                        <path d="M8 1a7 7 0 1 0 7 7h-1.5A5.5 5.5 0 1 1 8 2.5V5l4-3-4-3v2z"/>
                    </svg>
                </button>
                {% endif %}
            </span>
            {% endfor %}
        </div>
    </details>
    {% endif %}
</article>
{% endfor %}
