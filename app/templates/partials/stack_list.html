{% set ns = namespace(shown_divider=false, has_active=false) %}
{% for stack in stacks %}
    {% if stack.status.state in ("running", "partial") %}
        {% set ns.has_active = true %}
    {% endif %}
{% endfor %}

{% for stack in stacks %}
{% if stack.status.state == "stopped" and not ns.shown_divider and ns.has_active %}
    {% set ns.shown_divider = true %}
    <div class="stopped-divider"><small>Stopped</small></div>
{% endif %}
<article class="stack-card stack-{{ stack.status.state }}">
    <div class="stack-header">
        <div class="stack-info">
            <strong>{{ stack.name }}</strong>
            <small>
                {% if stack.mode == "pass" %}
                    <kbd class="mode-pass">pass</kbd>
                {% endif %}
                {% if stack.status.state == "running" %}
                    <span class="badge-running">{{ stack.status.running }}/{{ stack.status.total }} running</span>
                {% elif stack.status.state == "partial" %}
                    <span class="badge-partial">{{ stack.status.running }}/{{ stack.status.total }} running</span>
                {% else %}
                    <span class="badge-stopped">stopped</span>
                {% endif %}
            </small>
        </div>
        <div class="stack-actions">
            {% if stack.is_self %}
                <button disabled title="Cannot control stack-manager from within itself">self</button>
            {% elif stack.busy %}
                <button aria-busy="true" disabled>busy</button>
            {% elif stack.status.state in ("running", "partial") %}
                <button class="outline contrast"
                        hx-post="/api/stacks/{{ stack.name }}/stop"
                        hx-target="#modal-content"
                        hx-swap="innerHTML">Stop</button>
            {% else %}
                <button class="outline"
                        hx-post="/api/stacks/{{ stack.name }}/start"
                        hx-target="#modal-content"
                        hx-swap="innerHTML">Start</button>
            {% endif %}
        </div>
    </div>
    {% if stack.status.containers and stack.status.state != "stopped" %}
    <div class="stack-containers">
        {% for c in stack.status.containers %}
        <small class="container-pill container-{{ c.status }}">
            {{ c.name }}
            {% if c.health != "n/a" %}<span class="health-{{ c.health }}">{{ c.health }}</span>{% endif %}
        </small>
        {% endfor %}
    </div>
    {% endif %}
</article>
{% endfor %}
